<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCL Fantasy Pro Hub - LIVE</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #cbd5e1; --highlight: #f97316; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; text-align: center; }
        
        /* Navigatie & Selectoare */
        .nav-container { background: var(--card); padding: 15px 30px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin: 0 auto 30px auto; border: 1px solid #334155; width: 92%; max-width: 1400px; box-sizing: border-box; }
        .user-select-container { text-align: left; min-width: 180px; }
        .user-dropdown { background: linear-gradient(145deg, #1e293b, #0f172a); color: var(--accent); border: 1px solid #334155; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
        .tab-btn { background: #334155; color: #94a3b8; border: none; padding: 10px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 0 5px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        .sub-btn { background: transparent; color: #94a3b8; border: 1px solid #475569; padding: 8px 18px; border-radius: 20px; cursor: pointer; margin: 5px; font-size: 0.9em; }
        .sub-btn.active { background: #0ea5e9; color: white; border-color: #0ea5e9; }

        /* Containere si Carduri */
        .container { display: none; width: 95%; max-width: 1400px; margin: 0 auto; }
        .container.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        .grid-top { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        /* Tabele */
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #334155; text-align: center; }
        th { background: #162030; color: #94a3b8; text-transform: uppercase; font-size: 0.85em; cursor: pointer; }
        .highlight-user { background: rgba(56, 189, 248, 0.1) !important; }
        
        /* Teren Fotbal (TOTW) */
        .pitch-container { position: relative; width: 100%; height: 580px; background-color: #15803d; border: 3px solid white; border-radius: 12px; overflow: hidden; background-image: repeating-linear-gradient(0deg, #166534, #166534 60px, #15803d 60px, #15803d 120px); margin-top: 10px; }
        .pitch-line { position: absolute; border: 1.5px solid rgba(255,255,255,0.5); }
        .mid-circle { top: 50%; left: 50%; width: 100px; height: 100px; border-radius: 50%; transform: translate(-50%, -50%); }
        .mid-line { top: 50%; left: 0; width: 100%; height: 0; }
        
        /* Carduri Jucatori pe Teren */
        .totw-player { position: absolute; width: 90px; transform: translate(-50%, -50%); text-align: center; z-index: 10; }
        .totw-card { background: #1e293b; padding: 6px; border-radius: 6px; border: 2px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .totw-card.owned-by-me { border-color: var(--highlight); box-shadow: 0 0 15px rgba(249, 115, 22, 0.6); background: linear-gradient(145deg, #ea580c, #9a3412); }
        .totw-name { font-weight: bold; font-size: 0.75em; color: white; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .totw-pts { background: var(--accent); color: #0f172a; font-weight: 800; font-size: 0.85em; padding: 1px 5px; border-radius: 4px; }
        
        /* Pozitii pe teren */
        .row-fwd { bottom: 80%; } .row-mid { bottom: 55%; } .row-def { bottom: 30%; } .row-gk { bottom: 8%; }

        /* Badge-uri Puncte */
        .badge { padding: 4px 10px; border-radius: 5px; font-weight: bold; font-size: 0.8em; }
        .pk-green { background: #22c55e; color: #052e16; }
        .pk-orange { background: #f97316; color: white; }
        .pos-badge { font-size: 0.7em; padding: 3px 6px; border-radius: 3px; color: white; margin-right: 5px; font-weight: bold; }
        .pos-GK { background: #a855f7; } .pos-DEF { background: #22c55e; } .pos-MID { background: #3b82f6; } .pos-FWD { background: #ef4444; }

        /* Loading Spinner */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <div class="nav-container">
        <div class="user-select-container">
            <span style="font-size: 0.7em; color: #94a3b8; font-weight: bold;">CINE E»òTI?</span>
            <select id="user-dropdown" class="user-dropdown" onchange="updateUser(this.value)">
                <option value="">Alege manager...</option>
            </select>
        </div>
        <div>
            <div style="margin-bottom: 8px;">
                <button class="tab-btn active" onclick="changeMD(10, this)">MD 10</button>
                <button class="tab-btn" onclick="changeMD(9, this)">MD 9</button>
            </div>
            <div>
                <button class="sub-btn active" onclick="setView('INTERN', this)">üè† INTERN</button>
                <button class="sub-btn" onclick="setView('GLOBAL', this)">üåç GLOBAL</button>
                <button class="sub-btn" onclick="setView('TOTW', this)">üëï TOTW</button>
            </div>
        </div>
        <div style="min-width: 180px; text-align: right;">
            <button onclick="refreshData()" style="background: none; border: 1px solid #334155; color: #94a3b8; padding: 8px; border-radius: 5px; cursor: pointer;">üîÑ Refresh</button>
        </div>
    </div>

    <div id="content-area"></div>

    <script>
        let rawData = null;
        let currentMD = 10;
        let currentView = 'INTERN';
        let currentUser = localStorage.getItem('selectedUser') || '';

        async function loadData() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const response = await fetch(`/api/data?md=${currentMD}`);
                rawData = await response.json();
                populateDropdown();
                render();
            } catch (e) {
                console.error("Eroare la incarcare:", e);
            }
            document.getElementById('loader').style.display = 'none';
        }

        function populateDropdown() {
            const select = document.getElementById('user-dropdown');
            select.innerHTML = '<option value="">Alege manager...</option>';
            rawData.managers.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                if(m === currentUser) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function updateUser(val) {
            currentUser = val;
            localStorage.setItem('selectedUser', val);
            render();
        }

        function changeMD(md, btn) {
            currentMD = md;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadData();
        }

        function setView(view, btn) {
            currentView = view;
            document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        async function refreshData() {
            await fetch('/api/refresh', { method: 'POST' });
            loadData();
        }

        function render() {
            if(!rawData) return;
            const area = document.getElementById('content-area');
            
            if(currentView === 'INTERN') {
                renderIntern(area);
            } else if(currentView === 'GLOBAL') {
                renderGlobal(area);
            } else {
                renderTOTW(area);
            }
        }

        function renderIntern(area) {
            const liveRank = [...rawData.live_ranking].sort((a,b) => b.Scor - a.Scor);
            const overRank = [...rawData.overall_ranking].sort((a,b) => b.Total - a.Total);
            
            area.innerHTML = `
                <div class="container active">
                    <div class="grid-top">
                        <div class="card">
                            <h3>üî• Manager of the Day</h3>
                            <table>
                                <tr><th>Antrenor</th><th>Puncte</th></tr>
                                ${liveRank.map(r => `<tr class="${r.Antrenor === currentUser ? 'highlight-user' : ''}"><td>${r.Antrenor}</td><td><b>${r.Scor}</b></td></tr>`).join('')}
                            </table>
                        </div>
                        <div class="card">
                            <h3>üèÜ Clasament General</h3>
                            <table>
                                <tr><th>Pos</th><th>Antrenor</th><th>Total</th></tr>
                                ${overRank.map((r, i) => `<tr class="${r.Antrenor === currentUser ? 'highlight-user' : ''}"><td>${i+1}</td><td>${r.Antrenor}</td><td><b>${r.Total}</b></td></tr>`).join('')}
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGlobal(area) {
            area.innerHTML = `
                <div class="container active">
                    <div class="card">
                        <h3>üîç Scouting Database</h3>
                        <table>
                            <thead>
                                <tr><th>JucƒÉtor</th><th>Poz</th><th>EchipƒÉ</th><th>Puncte</th><th>Local %</th><th>Manageri</th></tr>
                            </thead>
                            <tbody>
                                ${rawData.players.sort((a,b) => b.points - a.points).slice(0, 50).map(p => {
                                    const locPk = Math.round((p.owners.length / rawData.managers.length) * 100);
                                    const isOwned = currentUser && p.owners.includes(currentUser);
                                    return `<tr class="${isOwned ? 'highlight-user' : ''}">
                                        <td style="text-align:left"><span class="pos-badge pos-${p.pos}">${p.pos}</span><b>${p.name}</b></td>
                                        <td>${p.pos}</td>
                                        <td>${p.team}</td>
                                        <td><b>${p.points}</b></td>
                                        <td><span class="badge ${locPk > 30 ? 'pk-orange' : 'pk-green'}">${locPk}%</span></td>
                                        <td style="font-size:0.8em">${p.owners.join(', ')}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderTOTW(area) {
            area.innerHTML = `
                <div class="container active">
                    <div class="totw-layout" style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap">
                        <div style="flex:1; min-width:400px; max-width:600px">
                            <h3>üè† Our League TOTW</h3>
                            <div class="pitch-container" id="pitch-internal"></div>
                        </div>
                        <div style="flex:1; min-width:400px; max-width:600px">
                            <h3>üåç Global TOTW</h3>
                            <div class="pitch-container" id="pitch-global"></div>
                        </div>
                    </div>
                </div>
            `;
            
            drawPitch(rawData.players, 'points', 'pitch-internal');
            // Nota: Punctele globale sunt tot 'points' dar luate dintr-un pool mai mare daca am avea
            drawPitch(rawData.players, 'points', 'pitch-global');
        }

        function drawPitch(players, key, containerId) {
            const pitch = document.getElementById(containerId);
            pitch.innerHTML = '<div class="pitch-line mid-line"></div><div class="pitch-line mid-circle"></div>';
            
            // Logica selectie TOTW (Tiebreaker: favorizeaza jucatorul lui currentUser)
            const sorted = [...players].sort((a, b) => {
                if(b[key] !== a[key]) return b[key] - a[key];
                const aOwn = currentUser && a.owners.includes(currentUser);
                const bOwn = currentUser && b.owners.includes(currentUser);
                return bOwn - aOwn;
            });

            let team = [], counts = { GK:0, DEF:0, MID:0, FWD:0 };
            
            // Selector 1-4-4-2 sau similar
            for(let p of sorted) {
                if(team.length >= 11) break;
                if(p.pos === 'GK' && counts.GK < 1) { team.push(p); counts.GK++; }
                else if(p.pos === 'DEF' && counts.DEF < 4) { team.push(p); counts.DEF++; }
                else if(p.pos === 'MID' && counts.MID < 4) { team.push(p); counts.MID++; }
                else if(p.pos === 'FWD' && counts.FWD < 2) { team.push(p); counts.FWD++; }
            }

            const rows = { 
                gk: team.filter(p => p.pos === 'GK'),
                def: team.filter(p => p.pos === 'DEF'),
                mid: team.filter(p => p.pos === 'MID'),
                fwd: team.filter(p => p.pos === 'FWD')
            };

            Object.keys(rows).forEach(rowKey => {
                const playersInRow = rows[rowKey];
                playersInRow.forEach((p, i) => {
                    const left = (100 / (playersInRow.length + 1)) * (i + 1);
                    const isMe = currentUser && p.owners.includes(currentUser);
                    const el = document.createElement('div');
                    el.className = `totw-player row-${rowKey}`;
                    el.style.left = `${left}%`;
                    el.innerHTML = `
                        <div class="totw-card ${isMe ? 'owned-by-me' : ''}">
                            <span class="totw-name">${p.name}</span>
                            <span class="totw-pts">${p[key]} PTS</span>
                        </div>
                    `;
                    pitch.appendChild(el);
                });
            });
        }

        window.onload = loadData;
    </script>
</body>
</html>
