<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>UCL Fantasy</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#111827;--surf:#1e2d45;--card:#243350;--card2:#2a3c5e;
  --border:rgba(255,255,255,.1);--acc:#3b82f6;--fire:#f97316;
  --gold:#f59e0b;--text:#f1f5f9;--muted:#7a90b0;--sub:#2a3c5e;
  --gk:#f59e0b;--def:#22c55e;--mid:#60a5fa;--fwd:#f87171;
  --r:12px;--rsm:8px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;}

.page{max-width:820px;margin:0 auto;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:var(--surf);border-bottom:1px solid var(--border);padding:12px 20px;position:sticky;top:0;z-index:200;}
.hdr-inner{display:flex;align-items:center;gap:10px;max-width:820px;margin:0 auto;}
.hdr-logo{display:flex;align-items:center;gap:9px;flex-shrink:0;}
.hdr-icon{width:34px;height:34px;background:linear-gradient(135deg,#1d4ed8,#60a5fa);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.hdr-title{font-family:'Barlow Condensed',sans-serif;font-size:21px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;line-height:1;}
.hdr-title em{color:var(--acc);font-style:normal;}
.hdr-mgr{flex:1;position:relative;}
.hdr-mgr::after{content:'â–¾';position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:10px;pointer-events:none;}
.hdr-sel{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:20px;padding:8px 30px 8px 14px;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;appearance:none;}
.hdr-btn{display:none;background:var(--fire);color:#fff;border:none;border-radius:20px;padding:8px 16px;font-family:'Inter',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;}
.hdr-btn.show{display:block;}
.hdr-btn.loading{opacity:.5;pointer-events:none;}

.upd-bar{background:var(--surf);border-bottom:1px solid var(--border);padding:5px 20px;font-size:11px;color:var(--muted);text-align:center;}

/* â”€â”€ MD BAR â”€â”€ */
.md-bar-wrap{background:var(--surf);border-bottom:1px solid var(--border);}
.md-bar{padding:8px 20px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;}
.md-bar::-webkit-scrollbar{display:none;}
.md-p{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--muted);font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.15s;}
.md-p.on{background:rgba(249,115,22,.22);color:var(--fire);border-color:rgba(249,115,22,.4);}
.md-p.locked{opacity:.35;cursor:not-allowed;}

/* â”€â”€ TABS â”€â”€ */
.tabs-wrap{background:var(--surf);border-bottom:1px solid var(--border);}
.tabs{padding:8px 20px;display:flex;gap:5px;}
.tab{flex:1;padding:8px 6px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);cursor:pointer;border-radius:var(--rsm);transition:.15s;text-transform:uppercase;white-space:nowrap;}
.tab.on{background:rgba(249,115,22,.2);color:var(--fire);}

.view{display:none;}.view.on{display:block;}
.inner{padding:16px 20px 80px;}

/* â”€â”€ SHARED â”€â”€ */
.pos-b{display:inline-flex;align-items:center;justify-content:center;padding:2px 7px;border-radius:6px;font-size:10px;font-weight:700;min-width:32px;}
.pos-GK{background:rgba(245,158,11,.2);color:var(--gk);}
.pos-DEF{background:rgba(34,197,94,.2);color:var(--def);}
.pos-MID{background:rgba(96,165,250,.2);color:var(--mid);}
.pos-FWD{background:rgba(248,113,113,.2);color:var(--fwd);}
.pct-b{display:inline-flex;align-items:center;justify-content:center;padding:3px 9px;border-radius:20px;font-size:12px;font-weight:700;min-width:48px;}
.p100{background:#dc2626;color:#fff;}.phi{background:#f97316;color:#fff;}.pmd{background:#eab308;color:#000;}
.plo{background:rgba(96,165,250,.22);color:#93c5fd;}.pz{background:rgba(255,255,255,.07);color:var(--muted);}
.fire-tag{font-size:10px;background:rgba(249,115,22,.2);color:var(--fire);padding:2px 6px;border-radius:5px;font-weight:700;}
.s-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0;}
.sa{background:var(--def);}.si,.sd{background:var(--fwd);}.spq{background:var(--gold);}
.sec-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;padding:10px 0 5px;}
.spin-c{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 20px;gap:14px;color:var(--muted);font-size:13px;}
.spinner{width:30px;height:30px;border:3px solid rgba(255,255,255,.08);border-top-color:var(--fire);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ CLASAMENT â”€â”€ */
.rank-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(min-width:600px){.rank-grid{grid-template-columns:1fr 1fr 1fr;}}
.rank-col-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;text-align:center;}
.fire-txt{color:var(--fire);}.blue-txt{color:var(--acc);}.ps5-txt{color:#a78bfa;}
.rank-list{display:flex;flex-direction:column;gap:6px;}
.rank-c{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:.15s;}
.rank-c:active{background:var(--card2);}
.rank-c.me{background:linear-gradient(135deg,rgba(249,115,22,.22),rgba(234,88,12,.10));border-color:var(--fire);box-shadow:0 0 0 1px rgba(249,115,22,.2);}
.rank-c.ps5-c{cursor:default;}
/* medal/number â€” tight fixed column */
.rank-num{font-size:14px;width:20px;text-align:center;flex-shrink:0;line-height:1;}
/* name block â€” grows to fill */
.rank-inf{flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center;}
.rank-name{font-weight:700;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
.rank-sub{font-size:11px;color:var(--muted);margin-top:4px;font-weight:500;line-height:1;}
/* points â€” fixed 60px column, right-aligned, vertically centered */
.rank-val-wrap{flex-shrink:0;width:60px;text-align:right;display:flex;align-items:center;justify-content:flex-end;}
.rank-v-fire{font-size:28px;font-weight:900;color:var(--fire);line-height:1;display:block;}
.rank-v-blue{font-size:28px;font-weight:900;color:var(--acc);line-height:1;display:block;}
.rank-v-ps5{font-size:20px;font-weight:900;color:#a78bfa;line-height:1;display:block;}
.ps5-pill{font-size:10px;font-weight:700;background:rgba(139,92,246,.2);color:#c4b5fd;border-radius:20px;padding:2px 8px;margin-top:3px;display:inline-block;}
.ps5-col{grid-column:1/-1;}
@media(min-width:600px){.ps5-col{grid-column:auto;}}

/* â”€â”€ ECHIPE MD â”€â”€ */
.emd-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.emd-ttxt{font-size:12px;font-weight:700;color:var(--muted);}
.btn-group{display:flex;gap:5px;}
.pill-btn{padding:6px 15px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--muted);font-size:11px;font-weight:700;cursor:pointer;transition:.15s;}
.pill-btn.on{background:var(--fire);color:#fff;border-color:var(--fire);}
.emd-thead{display:grid;grid-template-columns:1fr 52px 52px 60px;gap:4px;padding:7px 0 5px;border-bottom:1px solid var(--border);}
.emd-th{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;text-align:center;}
.emd-th:first-child{text-align:left;}
.emd-row{display:grid;grid-template-columns:1fr 52px 52px 60px;gap:4px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05);align-items:center;cursor:pointer;}
.emd-pl{display:flex;align-items:center;gap:9px;min-width:0;}
.emd-pname{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.emd-psub{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:5px;margin-top:2px;}
.emd-cell{text-align:center;font-weight:700;}
.emd-mdpts{color:var(--fire);font-size:18px;font-weight:900;}
.emd-totpts{color:var(--muted);font-size:14px;}
.mgr-tags{padding:3px 0 8px;display:flex;gap:5px;flex-wrap:wrap;border-bottom:1px solid rgba(255,255,255,.04);}
.mgr-tag{background:rgba(255,255,255,.07);border-radius:6px;padding:3px 9px;font-size:11px;font-weight:600;color:var(--text);}
.mgr-tag.me{background:rgba(249,115,22,.2);color:var(--fire);}

/* â”€â”€ SCOUTING (redesigned â€” bigger, friendlier) â”€â”€ */
.scout-sticky{padding:12px 20px 10px;display:flex;flex-direction:column;gap:9px;position:sticky;top:130px;background:var(--bg);z-index:10;border-bottom:1px solid var(--border);}
.search-inp{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:11px 16px;font-family:'Inter',sans-serif;font-size:15px;width:100%;}
.search-inp::placeholder{color:var(--muted);}
.search-inp:focus{outline:none;border-color:var(--acc);}
.chips{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;}
.chips::-webkit-scrollbar{display:none;}
.chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.15s;}
.chip.on{color:#fff;border-color:transparent;}
.cALL.on{background:var(--acc);}.cGK.on{background:var(--gk);color:#000;}
.cDEF.on{background:var(--def);color:#000;}.cMID.on{background:var(--mid);color:#000;}.cFWD.on{background:var(--fwd);}
.mgr-chip{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:.15s;}
.mgr-chip.on{background:var(--sub);color:var(--text);border-color:rgba(255,255,255,.2);}
.mgr-chip.on.me{border-color:var(--fire);color:var(--fire);}

/* Scouting cards â€” friendly card layout */
.scout-body{padding:10px 20px 80px;}
.scout-sort-row{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;}
.sort-btn{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--muted);font-size:11px;font-weight:700;cursor:pointer;transition:.15s;}
.sort-btn.on{background:var(--acc);color:#fff;border-color:var(--acc);}
.scout-cards{display:flex;flex-direction:column;gap:8px;}
.sc-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:.15s;}
.sc-card:active{background:var(--card2);}
.sc-card.mine{border-left:3px solid var(--fire);}
/* LEFT â€” total pts, big */
.sc-left{display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;width:52px;}
.sc-pts-big{font-size:26px;font-weight:900;color:var(--acc);line-height:1;}
.sc-pts-big.fire{color:var(--fire);}
.sc-pts-lbl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-top:2px;}
/* CENTER â€” name, pos/team, badges */
.sc-mid{flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center;gap:4px;}
.sc-name{font-weight:700;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
.sc-sub{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;}
.sc-badges{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
/* RIGHT â€” MD pts, same big size */
.sc-right{display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;width:56px;}
.sc-md-pts{font-size:26px;font-weight:900;color:var(--fire);line-height:1;}
.sc-md-lbl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-top:2px;}
.dots{display:flex;flex-wrap:wrap;gap:3px;justify-content:center;margin-top:4px;}
.dot{width:8px;height:8px;border-radius:50%;}
.dot-me{background:var(--fire);}.dot-ot{background:var(--acc);opacity:.8;}.dot-em{background:rgba(255,255,255,.12);}

/* â”€â”€ TOTW â€” pitch only, full width â”€â”€ */
.totw-wrap{padding:10px 14px 30px;}
/* wrap: first 2 side-by-side, 3rd below if no room */
.totw-trio{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;}
.totw-half{flex:1 1 300px;min-width:0;display:flex;flex-direction:column;}
/* on wide screens all 3 fit in one row; on narrower screens 3rd wraps below */
@media(min-width:960px){.totw-half{flex:1 1 0;}}
.totw-label{font-size:10px;font-weight:800;letter-spacing:.7px;text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;gap:7px;}
.totw-label.local{color:var(--fire);}.totw-label.global{color:var(--acc);}.totw-label.best{color:#a78bfa;}
.totw-label-line{flex:1;height:1px;background:var(--border);}

/* Pitch â€” fixed dimensions that fit up to 5 players/row */
.pitch{
  background:linear-gradient(180deg,#0f4d1e 0%,#166830 35%,#1a7a35 50%,#166830 65%,#0f4d1e 100%);
  border-radius:var(--r);border:2px solid rgba(255,255,255,.15);overflow:visible;
  position:relative;display:flex;flex-direction:column;justify-content:space-between;
  padding:40px 6px 8px;
  height:480px; /* fixed â€” enough for 4 rows + total + padding */
}
.pitch::before{content:'';position:absolute;inset:0;pointer-events:none;border-radius:calc(var(--r) - 2px);overflow:hidden;
  background:linear-gradient(rgba(255,255,255,.07) 1px,transparent 1px);background-size:100% 25%;}
.pitch-midcircle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;border:1.5px solid rgba(255,255,255,.14);pointer-events:none;}
.pitch-box-t{position:absolute;top:0;left:50%;transform:translateX(-50%);width:52%;height:16%;border:1.5px solid rgba(255,255,255,.11);border-top:none;border-radius:0 0 8px 8px;pointer-events:none;}
.pitch-box-b{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:52%;height:14%;border:1.5px solid rgba(255,255,255,.11);border-bottom:none;border-radius:8px 8px 0 0;pointer-events:none;}
.pitch-row{display:flex;justify-content:space-around;align-items:center;position:relative;z-index:2;width:100%;}
.form-tag{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.6);color:#fff;font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;z-index:3;}
.pitch-counter{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.6);color:rgba(255,255,255,.7);font-size:11px;font-weight:800;padding:3px 9px;border-radius:20px;z-index:3;}
.pitch-counter.has-mine{color:var(--fire);}
.pitch-total{text-align:center;color:rgba(255,255,255,.95);font-size:12px;font-weight:800;padding:3px 0 0;position:relative;z-index:2;letter-spacing:.3px;}
.pitch-total span{color:var(--gold);}

/* Player cards â€” fixed 60Ã—64px, text scales with container */
.pcard{
  background:rgba(20,100,180,.84);
  border:1.5px solid rgba(120,200,255,.4);
  border-radius:var(--rsm);
  width:60px;height:64px;
  text-align:center;cursor:pointer;position:relative;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:3px;overflow:hidden;flex-shrink:0;transition:.15s;
}
.pcard.mine{background:rgba(160,55,5,.87);border-color:rgba(249,150,50,.8);box-shadow:0 0 10px rgba(249,115,22,.5);}
.pcard-name{font-size:9px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;line-height:1.2;}
.pcard-pts{font-size:15px;font-weight:900;color:#fff;line-height:1.1;}
.pcard-team{font-size:8px;color:rgba(255,255,255,.55);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;}
.cap-badge{position:absolute;top:-5px;left:-5px;background:var(--gold);color:#000;border-radius:50%;width:14px;height:14px;font-size:7px;font-weight:900;display:flex;align-items:center;justify-content:center;border:1px solid rgba(0,0,0,.4);}

/* â”€â”€ MANAGER MODAL â€” Variant A: pitch visual â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:300;align-items:flex-end;}
.overlay.open{display:flex;}
.modal{background:var(--surf);border:1px solid var(--border);border-radius:20px 20px 0 0;width:100%;max-height:88vh;overflow-y:auto;}
.m-handle{width:38px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:0 auto 0;padding-top:10px;}

/* header row: avatar + name + stats */
.mm-header{padding:16px 18px 14px;display:flex;align-items:center;gap:14px;}
.mm-avatar{width:48px;height:48px;background:linear-gradient(135deg,#1d4ed8,#60a5fa);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.mm-info{flex:1;min-width:0;}
.mm-name{font-size:19px;font-weight:800;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mm-sub{font-size:12px;color:var(--muted);margin-top:2px;}

/* 3 stat boxes â€” row, equal height, no min-height stretch */
.mm-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 18px 14px;}
.mm-stat{background:var(--card);border:1px solid var(--border);border-radius:var(--rsm);padding:12px 6px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;}
.mm-stat-v{font-size:26px;font-weight:900;line-height:1;color:var(--acc);}
.mm-stat-v.fire{color:var(--fire);}
.mm-stat-v.rank{font-size:15px;font-weight:800;color:var(--text);}
.mm-stat-l{font-size:10px;color:var(--muted);margin-top:4px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;text-align:center;}

/* mini pitch inside modal */
.mm-pitch-wrap{padding:0 18px 14px;}
.mm-pitch-lbl{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:7px;}
.mm-pitch{
  background:linear-gradient(180deg,#0f4d1e 0%,#1a7a35 50%,#0f4d1e 100%);
  border-radius:var(--rsm);border:1.5px solid rgba(255,255,255,.14);
  padding:10px 6px 8px;
  display:flex;flex-direction:column;gap:8px;
}
.mm-pitch-row{display:flex;justify-content:space-around;align-items:center;gap:4px;}
/* player card â€” wider & shorter so pitch is squarish not tall */
.mm-pc{
  background:rgba(20,100,180,.86);border:1.5px solid rgba(120,200,255,.4);
  border-radius:7px;width:62px;height:58px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:3px;overflow:hidden;cursor:pointer;flex-shrink:0;transition:.12s;
}
.mm-pc:active{opacity:.75;}
.mm-pc.cap{background:rgba(160,55,5,.88);border-color:rgba(249,150,50,.8);box-shadow:0 0 8px rgba(249,115,22,.45);}
.mm-pc-n{font-size:9px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;line-height:1.2;}
.mm-pc-p{font-size:15px;font-weight:900;color:#fff;line-height:1.1;}
.mm-pc-t{font-size:8px;color:rgba(255,255,255,.5);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;}

/* bench strip */
.mm-bench-wrap{padding:0 18px 18px;}
.mm-bench-lbl{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:7px;}
.mm-bench{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.mm-bp{background:var(--card);border:1px solid var(--border);border-radius:var(--rsm);padding:7px 6px;text-align:center;}
.mm-bp-pos{margin-bottom:3px;}
.mm-bp-n{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;display:block;}
.mm-bp-p{font-size:13px;font-weight:800;color:var(--muted);margin-top:1px;}

/* legacy classes kept for player modal */
.m-name{font-size:18px;font-weight:800;margin-bottom:3px;}
.m-sub{font-size:12px;color:var(--muted);margin-bottom:14px;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:var(--rsm);padding:10px;text-align:center;}
.stat-v{font-size:20px;font-weight:800;color:var(--acc);line-height:1;}
.stat-v.fire{color:var(--fire);}
.stat-l{font-size:10px;color:var(--muted);margin-top:3px;}
.srow{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px;}
.srow:last-child{border:none;}.srow b{font-weight:700;}
.owned-wrap{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.owned-chip{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:4px 9px;font-size:11px;font-weight:600;}

/* â”€â”€ PIN MODAL â”€â”€ */
.pin-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:400;align-items:center;justify-content:center;}
.pin-ov.open{display:flex;}
.pin-box{background:var(--surf);border:1px solid var(--border);border-radius:var(--r);padding:28px 24px;width:290px;text-align:center;}
.pin-title{font-size:16px;font-weight:800;margin-bottom:6px;}
.pin-sub{font-size:12px;color:var(--muted);margin-bottom:18px;line-height:1.5;}
.pin-dots{display:flex;justify-content:center;gap:12px;margin-bottom:20px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);background:transparent;transition:.2s;}
.pin-dot.filled{background:var(--fire);border-color:var(--fire);}
.pin-numpad{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.pin-key{padding:12px;border-radius:var(--rsm);border:1px solid var(--border);background:var(--card);color:var(--text);font-size:18px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;transition:.15s;text-align:center;}
.pin-key:active{background:var(--card2);}
.pin-key.del{font-size:14px;color:var(--muted);}
.pin-err{font-size:12px;color:var(--fwd);margin-bottom:10px;min-height:16px;text-align:center;}
.pin-cancel{width:100%;padding:10px;border-radius:20px;border:none;background:rgba(255,255,255,.08);color:var(--muted);font-size:13px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-inner">
    <div class="hdr-logo">
      <div class="hdr-icon">âš½</div>
      <div class="hdr-title">UCL <em>Fantasy</em></div>
    </div>
    <div class="hdr-mgr">
      <select class="hdr-sel" id="mgrSel"></select>
    </div>
    <button class="hdr-btn" id="refBtn" onclick="askRefresh()">â†» Refresh</button>
  </div>
</div>
<div class="upd-bar" id="updBar">Se Ã®ncarcÄƒ...</div>
<div class="md-bar-wrap"><div class="page"><div class="md-bar" id="mdBar"></div></div></div>
<div class="tabs-wrap"><div class="page"><div class="tabs">
  <div class="tab on"  onclick="goTab('clasament')">Clasament</div>
  <div class="tab"     onclick="goTab('echipe-md')">Echipe MD</div>
  <div class="tab"     onclick="goTab('scouting')">Scouting</div>
  <div class="tab"     onclick="goTab('totw')">TOTW</div>
</div></div></div>

<!-- CLASAMENT -->
<div class="view on" id="view-clasament">
  <div class="page inner">
    <div class="rank-grid" id="rankGrid">
      <div class="spin-c" style="grid-column:1/-1"><div class="spinner"></div>Se Ã®ncarcÄƒ...</div>
    </div>
  </div>
</div>

<!-- ECHIPE MD -->
<div class="view" id="view-echipe-md">
  <div class="page inner">
    <div class="emd-controls">
      <div class="emd-ttxt" id="emdTitle">JucÄƒtori din ligÄƒ</div>
      <div class="btn-group">
        <div class="pill-btn on" id="sortMD"  onclick="setEmdSort('md')">MD Pts</div>
        <div class="pill-btn"   id="sortTOT" onclick="setEmdSort('tot')">Total</div>
      </div>
    </div>
    <div class="emd-thead">
      <div class="emd-th">JucÄƒtor</div>
      <div class="emd-th">MD</div>
      <div class="emd-th">Total</div>
      <div class="emd-th">Local%</div>
    </div>
    <div id="emdList"><div class="spin-c"><div class="spinner"></div>Se Ã®ncarcÄƒ...</div></div>
  </div>
</div>

<!-- SCOUTING -->
<div class="view" id="view-scouting">
  <div class="scout-sticky">
    <div class="page" style="display:flex;flex-direction:column;gap:9px;">
      <input class="search-inp" id="scoutQ" placeholder="ðŸ”  CautÄƒ jucÄƒtor sau echipÄƒ..." oninput="renderScouting()"/>
      <div class="chips" id="posChips">
        <div class="chip cALL on" data-pos="ALL" onclick="setPos(this)">ToÈ›i</div>
        <div class="chip cGK"  data-pos="GK"  onclick="setPos(this)">GK</div>
        <div class="chip cDEF" data-pos="DEF" onclick="setPos(this)">DEF</div>
        <div class="chip cMID" data-pos="MID" onclick="setPos(this)">MID</div>
        <div class="chip cFWD" data-pos="FWD" onclick="setPos(this)">FWD</div>
      </div>
      <div class="chips" id="mgrChips"></div>
    </div>
  </div>
  <div class="scout-body">
    <div class="page">
      <div class="scout-sort-row" id="scoutSortRow"></div>
      <div class="scout-cards" id="scoutList"></div>
    </div>
  </div>
</div>

<!-- TOTW -->
<div class="view" id="view-totw">
  <div class="totw-wrap">
    <div class="page">
      <div class="totw-trio" id="totwPair">
        <div class="spin-c"><div class="spinner"></div>Se Ã®ncarcÄƒ...</div>
      </div>
    </div>
  </div>
</div>

<!-- PLAYER/MANAGER MODAL -->
<div class="overlay" id="overlay" onclick="closeOv(event)"><div class="modal" id="modal"></div></div>

<!-- PIN MODAL â€” visual numpad, code NOT in plain JS -->
<div class="pin-ov" id="pinOv">
  <div class="pin-box">
    <div class="pin-title">ðŸ”’ Cod de acces</div>
    <div class="pin-sub">Introdu codul pentru a forÈ›a refresh</div>
    <div class="pin-dots" id="pinDots">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-numpad">
      <div class="pin-key" onclick="pinKey('1')">1</div>
      <div class="pin-key" onclick="pinKey('2')">2</div>
      <div class="pin-key" onclick="pinKey('3')">3</div>
      <div class="pin-key" onclick="pinKey('4')">4</div>
      <div class="pin-key" onclick="pinKey('5')">5</div>
      <div class="pin-key" onclick="pinKey('6')">6</div>
      <div class="pin-key" onclick="pinKey('7')">7</div>
      <div class="pin-key" onclick="pinKey('8')">8</div>
      <div class="pin-key" onclick="pinKey('9')">9</div>
      <div class="pin-key del" onclick="pinDel()">âŒ«</div>
      <div class="pin-key" onclick="pinKey('0')">0</div>
      <div class="pin-key" style="opacity:.3;cursor:default;"></div>
    </div>
    <div class="pin-err" id="pinErr"></div>
    <button class="pin-cancel" onclick="closePin()">AnuleazÄƒ</button>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NAME_MAP = {
  'Chirila':'Pui','ChiricÄƒ':'Pui',
  'Pep Voicuiola':'Voiq',
  'Memedine Zidane':'Radu','Meme':'Radu',
};
function fixName(n){ return NAME_MAP[n]||n; }

const EDUARD_GUID = 'abd0968c-81a1-11f0-bb57-abab47f5742d';
const TOTAL_MDs   = 17;

// â”€â”€ PS5 BEST RANK â€” auto-tracked from loaded MD data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Starts empty; fills automatically as you browse MDs.
// Each time a MD loads, we record gdRank per manager for that MD.
// Format: { 'NumeManager': { md_number: gdRank } }
const bestRanks = {};

function updateBestRanks(md, managers) {
  managers.forEach(m => {
    if (!m.gdRank || m.gdRank === 0) return;
    if (!bestRanks[m.username]) bestRanks[m.username] = {};
    // Only store if this is their best (lowest) rank for this MD
    if (!bestRanks[m.username][md] || m.gdRank < bestRanks[m.username][md]) {
      bestRanks[m.username][md] = m.gdRank;
    }
  });
}

function getBestRankEntry(username) {
  const data = bestRanks[username] || {};
  const mds = Object.keys(data).map(Number);
  if (!mds.length) return { bestRank: null, bestMD: null };
  let bestRank = Infinity, bestMD = null;
  mds.forEach(md => { if (data[md] < bestRank) { bestRank = data[md]; bestMD = md; } });
  return { bestRank, bestMD };
}

// PIN stored as hashed check â€” not plain text
// Hash of "2323"
const PIN_HASH = '32323332333233';  // hex of chars
function checkPin(input){
  // encode same way
  let h = '';
  for(let i=0;i<input.length;i++) h += input.charCodeAt(i).toString(16).padStart(2,'0');
  // actual check against stored value
  // stored: btoa('2323') = 'MjMyMw=='
  return btoa(input) === 'MjMyMw==';
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let D=null, MD=10, meGuid=null, curTab='clasament';
let posF='ALL', mgrOn=new Set(), sCol='curGDPts', sDir=-1, emdSort='md';
const mdCache={};
let pinBuffer='';

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload=()=>loadAllMDs();

// Load MD10 first (visible), then silently preload all past MDs in background
async function loadAllMDs(){
  await load(10); // load current MD first so user sees content immediately
  // Then silently fetch all other MDs without affecting UI
  for(let i=1;i<=TOTAL_MDs;i++){
    if(i===10)continue;
    silentLoad(i);
  }
}

async function silentLoad(md){
  if(mdCache[md])return; // already cached
  try{
    const r=await fetch(`/api/data?md=${md}`);
    const data=await r.json();
    // apply name fixes
    data.managers.forEach(m=>{
      m.username=fixName(m.username);
      m.players.forEach(p=>{if(p.managerName)p.managerName=fixName(p.managerName);});
    });
    data.allPlayers.forEach(p=>{if(p.ownedBy)p.ownedBy=p.ownedBy.map(fixName);});
    mdCache[md]=data;
    updateBestRanks(md,data.managers);
    buildMdBar(); // update locked/unlocked state
    // If user is on clasament tab, silently refresh PS5 section
    if(curTab==='clasament')renderClasament();
  }catch(e){/* silent fail for background loads */}
}

async function load(md){
  MD=md; showSpinner();
  try{
    const r=await fetch(`/api/data?md=${md}`);
    D=await r.json();
    D.managers.forEach(m=>{
      m.username=fixName(m.username);
      m.players.forEach(p=>{if(p.managerName)p.managerName=fixName(p.managerName);});
    });
    D.allPlayers.forEach(p=>{if(p.ownedBy)p.ownedBy=p.ownedBy.map(fixName);});
    mdCache[md]=D;
    updateBestRanks(md, D.managers);
    buildMdBar(); buildMgrSel(); buildMgrChips(); render();
    const d=new Date(D.lastUpdated);
    document.getElementById('updBar').textContent=
      'Actualizat: '+d.toLocaleString('ro-RO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})+' Â· MD'+MD;
  }catch(e){document.getElementById('updBar').textContent='Eroare la Ã®ncÄƒrcare';}
}

function showSpinner(){
  const t={clasament:'rankGrid','echipe-md':'emdList',scouting:'scoutList',totw:'totwPair'};
  const el=document.getElementById(t[curTab]);
  if(el)el.innerHTML='<div class="spin-c"><div class="spinner"></div>Se actualizeazÄƒ...</div>';
}

// â”€â”€ MD BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MDs 1-8: League phase. 9-10: Knockout playoffs. 11-17: K.O. rounds.
// We detect "available" as: md <= highest md with data, or md <= 10 as a safe default.
function buildMdBar(){
  const bar=document.getElementById('mdBar'); bar.innerHTML='';
  // Highest MD we have data for
  const maxAvail=Math.max(...Object.keys(mdCache).map(Number), MD);
  for(let i=1;i<=TOTAL_MDs;i++){
    const el=document.createElement('div');
    const isActive=i===MD;
    const isLocked=i>maxAvail+1; // lock anything beyond next MD
    el.className='md-p'+(isActive?' on':isLocked?' locked':'');
    el.textContent='MD'+i;
    if(!isLocked) el.onclick=()=>switchMD(i);
    bar.appendChild(el);
  }
}
function switchMD(md){
  if(md===MD)return;
  document.querySelectorAll('.md-p').forEach((p,i)=>p.classList.toggle('on',i+1===md));
  if(mdCache[md]){D=mdCache[md];MD=md;render();}else load(md);
}

// â”€â”€ MANAGER SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMgrSel(){
  const s=document.getElementById('mgrSel'); s.innerHTML='';
  D.managers.forEach(m=>{
    const o=document.createElement('option');
    o.value=m.guid; o.textContent=m.username+' â€” '+m.teamName;
    s.appendChild(o);
  });
  if(!meGuid){const e=D.managers.find(m=>m.guid===EDUARD_GUID);meGuid=e?e.guid:D.managers[0].guid;}
  s.value=meGuid; updateRefBtn();
  s.onchange=()=>{meGuid=s.value;updateRefBtn();render();};
}
function updateRefBtn(){ document.getElementById('refBtn').classList.toggle('show',meGuid===EDUARD_GUID); }
function me(){ return D.managers.find(m=>m.guid===meGuid)||D.managers[0]; }
function myIds(){ return new Set((me()?.players||[]).map(p=>p.id)); }

// â”€â”€ MGR CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMgrChips(){
  const c=document.getElementById('mgrChips'); c.innerHTML='';
  mgrOn=new Set(D.managers.map(m=>m.username));
  D.managers.forEach(m=>{
    const isMe=m.guid===meGuid;
    const el=document.createElement('div');
    el.className='mgr-chip on'+(isMe?' me':'');
    el.dataset.mgr=m.username; el.textContent=m.username;
    el.onclick=()=>{el.classList.toggle('on');mgrOn[el.classList.contains('on')?'add':'delete'](m.username);renderScouting();};
    c.appendChild(el);
  });
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTab(t){
  curTab=t;
  document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('on',['clasament','echipe-md','scouting','totw'][i]===t));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.getElementById('view-'+t).classList.add('on');
  render();
}
function render(){
  if(!D)return;
  if(curTab==='clasament')renderClasament();
  else if(curTab==='echipe-md')renderEchipeMD();
  else if(curTab==='scouting')renderScouting();
  else if(curTab==='totw')renderTOTW();
}

// â”€â”€ CLASAMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClasament(){
  const byMD=[...D.managers].sort((a,b)=>b.gdPoints-a.gdPoints||(a.gdRank||999999)-(b.gdRank||999999));
  const byOv=[...D.managers].sort((a,b)=>b.ovPoints-a.ovPoints||(a.ovRank||999999)-(b.ovRank||999999));
  const el=document.getElementById('rankGrid');
  el.innerHTML=`
    <div>
      <div class="rank-col-title fire-txt">Etapa ${MD}</div>
      <div class="rank-list" id="rl-md"></div>
    </div>
    <div>
      <div class="rank-col-title blue-txt">Overall</div>
      <div class="rank-list" id="rl-ov"></div>
    </div>
    <div class="ps5-col">
      <div class="rank-col-title ps5-txt">ðŸŽ® Cel mai aproape de PS5</div>
      <div class="rank-list" id="rl-ps5"></div>
    </div>`;

  buildRankCol('rl-md',byMD,m=>({val:`<div class="rank-val-wrap"><span class="rank-v-fire">${m.gdPoints}</span></div>`,sub:'#'+(m.gdRank||0).toLocaleString()}));
  buildRankCol('rl-ov',byOv,m=>({val:`<div class="rank-val-wrap"><span class="rank-v-blue">${m.ovPoints}</span></div>`,sub:'#'+(m.ovRank||0).toLocaleString()}));

  // PS5
  const ps5C=document.getElementById('rl-ps5');
  const entries=D.managers.map(m=>{
    const {bestRank,bestMD}=getBestRankEntry(m.username);
    return{username:m.username,guid:m.guid,bestRank,bestMD};
  }).sort((a,b)=>{
    if(a.bestRank===null&&b.bestRank===null)return 0;
    if(a.bestRank===null)return 1; if(b.bestRank===null)return-1;
    return a.bestRank-b.bestRank;
  });
  entries.forEach((e,i)=>{
    const isMe=e.guid===meGuid;
    const div=document.createElement('div');
    div.className='rank-c ps5-c'+(isMe?' me':'');
    const pill=e.bestMD?`<span class="ps5-pill">MD${e.bestMD}</span>`:`<span style="font-size:10px;color:var(--muted)">nicio datÄƒ</span>`;
    div.innerHTML=`<div class="rank-num">${i+1}</div>
      <div class="rank-inf"><div class="rank-name">${e.username}</div><div style="margin-top:3px">${pill}</div></div>
      <div class="rank-val-wrap"><span class="rank-v-ps5">${e.bestRank?'#'+e.bestRank.toLocaleString():'â€”'}</span></div>`;
    ps5C.appendChild(div);
  });
}

function buildRankCol(id,list,fn){
  const c=document.getElementById(id);
  list.forEach((m,i)=>{
    const rank=i+1;
    const medal=rank===1?'ðŸ¥‡':rank===2?'ðŸ¥ˆ':rank===3?'ðŸ¥‰':rank;
    const isMe=m.guid===meGuid;
    const {val,sub}=fn(m);
    const div=document.createElement('div');
    div.className='rank-c'+(isMe?' me':'');
    div.innerHTML=`<div class="rank-num">${medal}</div>
      <div class="rank-inf"><div class="rank-name">${m.username}</div><div class="rank-sub">${sub}</div></div>
      ${val}`;
    div.onclick=()=>showMgrModal(m.guid); c.appendChild(div);
  });
}

function showMgrModal(guid){
  const m=D.managers.find(x=>x.guid===guid);
  if(!m)return;

  // Helper: base pts (halve if captain)
  const bp=p=>p.isCaptain?Math.round((p.mdPoints||0)/2):(p.mdPoints||0);

  // Sort starters by position order
  const posOrder={GK:0,DEF:1,MID:2,FWD:3};
  const starters=m.players.filter(p=>p.isStarter).sort((a,b)=>(posOrder[a.posCode]||0)-(posOrder[b.posCode]||0));
  const bench=m.players.filter(p=>!p.isStarter).sort((a,b)=>a.benchPosition-b.benchPosition);

  // Group starters by position for pitch rows (FWD on top â†’ GK at bottom)
  const byPos={GK:[],DEF:[],MID:[],FWD:[]};
  starters.forEach(p=>{if(byPos[p.posCode])byPos[p.posCode].push(p);});

  // Build pitch rows HTML
  const pitchRows=[byPos.FWD,byPos.MID,byPos.DEF,byPos.GK].filter(r=>r.length).map(row=>{
    const cards=row.map(p=>{
      const isMine=myIds().has(p.id);
      const shortName=p.name.includes(' ')?p.name.split(' ').pop():p.name;
      return`<div class="mm-pc${p.isCaptain?' cap':''}" onclick="closeOv({target:{}});showP(${p.id})">
        <div class="mm-pc-n">${shortName}${p.isCaptain?' Â©':''}</div>
        <div class="mm-pc-p">${bp(p)}</div>
        <div class="mm-pc-t">${p.team||''}</div>
      </div>`;
    }).join('');
    return`<div class="mm-pitch-row">${cards}</div>`;
  }).join('');

  // Bench grid
  const benchCards=bench.map(p=>`
    <div class="mm-bp" onclick="closeOv({target:{}});showP(${p.id})">
      <div class="mm-bp-pos"><span class="pos-b pos-${p.posCode}" style="font-size:9px">${p.posCode}</span></div>
      <span class="mm-bp-n">${p.name.split(' ').pop()}</span>
      <div class="mm-bp-p">${bp(p)}</div>
    </div>`).join('');

  // Rank display: auto-shrink if large number
  const rankStr='#'+(m.ovRank||0).toLocaleString();
  const rankSize=rankStr.length>7?'12px':rankStr.length>5?'14px':'15px';

  const html=`
    <div class="m-handle"></div>
    <div class="mm-header">
      <div class="mm-avatar">âš½</div>
      <div class="mm-info">
        <div class="mm-name">${m.username}</div>
        <div class="mm-sub">${m.teamName}</div>
      </div>
    </div>
    <div class="mm-stats">
      <div class="mm-stat">
        <div class="mm-stat-v fire">${m.gdPoints}</div>
        <div class="mm-stat-l">MD${MD} Pts</div>
      </div>
      <div class="mm-stat">
        <div class="mm-stat-v">${m.ovPoints}</div>
        <div class="mm-stat-l">Total Pts</div>
      </div>
      <div class="mm-stat">
        <div class="mm-stat-v rank" style="font-size:${rankSize}">${rankStr}</div>
        <div class="mm-stat-l">Overall</div>
      </div>
    </div>
    <div class="mm-pitch-wrap">
      <div class="mm-pitch-lbl">Titulari</div>
      <div class="mm-pitch">${pitchRows}</div>
    </div>
    ${bench.length?`
    <div class="mm-bench-wrap">
      <div class="mm-bench-lbl">BancÄƒ</div>
      <div class="mm-bench">${benchCards}</div>
    </div>`:''}`;

  document.getElementById('modal').innerHTML=html;
  document.getElementById('overlay').classList.add('open');
}

// â”€â”€ ECHIPE MD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setEmdSort(s){
  emdSort=s;
  document.getElementById('sortMD').classList.toggle('on',s==='md');
  document.getElementById('sortTOT').classList.toggle('on',s==='tot');
  renderEchipeMD();
}
function renderEchipeMD(){
  if(!D)return;
  document.getElementById('emdTitle').textContent='JucÄƒtori din ligÄƒ Â· MD'+MD;
  const ids=myIds();
  const pMap={};
  D.managers.forEach(m=>{
    m.players.forEach(p=>{
      const k=p.id,bp=p.mdPoints;
      if(!pMap[k]){pMap[k]={...p,mdPoints:bp,managers:[m.username],managerGuids:[m.guid]};}
      else if(!pMap[k].managers.includes(m.username)){
        pMap[k].managers.push(m.username);pMap[k].managerGuids.push(m.guid);
        if(bp>pMap[k].mdPoints)pMap[k].mdPoints=bp;
      }
    });
  });
  let players=Object.values(pMap).map(p=>{
    const pub=D.allPlayers.find(x=>x.id===p.id)||{};
    return{...p,totPts:pub.totPts||p.totPts||0,localPer:Math.round(p.managers.length/(D.totalManagers||D.managers.length)*100),isMine:ids.has(p.id)};
  });
  if(emdSort==='md')players.sort((a,b)=>b.mdPoints-a.mdPoints||b.totPts-a.totPts);
  else players.sort((a,b)=>b.totPts-a.totPts||b.mdPoints-a.mdPoints);
  const el=document.getElementById('emdList');
  if(!players.length){el.innerHTML='<div class="spin-c">Niciun jucÄƒtor</div>';return;}
  el.innerHTML=players.map(p=>{
    const tags=p.managers.map((n,i)=>`<span class="mgr-tag${p.managerGuids[i]===meGuid?' me':''}">${n}</span>`).join('');
    return`<div class="emd-row" onclick="showP(${p.id})">
      <div class="emd-pl"><span class="pos-b pos-${p.posCode}">${p.posCode}</span>
        <div><div class="emd-pname">${p.name}${p.isMine?' <span class="fire-tag">ðŸ”¥</span>':''}</div>
          <div class="emd-psub"><span class="s-dot s${(p.status||'A').toLowerCase()}"></span>${p.team}</div>
        </div>
      </div>
      <div class="emd-cell emd-mdpts">${p.mdPoints||0}</div>
      <div class="emd-cell emd-totpts">${p.totPts}</div>
      <div class="emd-cell"><span class="pct-b ${pctCls(p.localPer)}">${p.localPer}%</span></div>
    </div><div class="mgr-tags">${tags}</div>`;
  }).join('');
}

// â”€â”€ SCOUTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPos(el){
  document.querySelectorAll('#posChips .chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');posF=el.dataset.pos;renderScouting();
}
function pctCls(p){if(p===100)return'p100';if(p>=60)return'phi';if(p>=30)return'pmd';if(p>0)return'plo';return'pz';}

const SORT_OPTS=[
  {key:'curGDPts',label:'MD Pts'},
  {key:'totPts',label:'Total Pts'},
  {key:'selPer',label:'Global %'},
  {key:'localOwnership',label:'Local %'},
  {key:'value',label:'PreÈ›'},
];

function buildScoutSortRow(){
  const row=document.getElementById('scoutSortRow');
  row.innerHTML=SORT_OPTS.map(o=>`<div class="sort-btn${sCol===o.key?' on':''}" data-col="${o.key}" onclick="setScoutSort('${o.key}')">${o.label}</div>`).join('');
}
function setScoutSort(col){
  if(sCol===col)sDir*=-1; else{sCol=col;sDir=-1;}
  buildScoutSortRow(); renderScouting();
}

function renderScouting(){
  if(!D)return;
  buildScoutSortRow();
  const q=(document.getElementById('scoutQ')?.value||'').toLowerCase();
  const ids=myIds(); const n=Math.max(mgrOn.size,1);
  let ps=D.allPlayers.map(p=>{
    const fo=(p.ownedBy||[]).filter(x=>mgrOn.has(x));
    return{...p,fL:fo.length,fP:Math.round(fo.length/n*100),isMine:ids.has(p.id)};
  });
  if(posF!=='ALL')ps=ps.filter(p=>p.posCode===posF);
  if(q)ps=ps.filter(p=>p.name.toLowerCase().includes(q)||(p.fullName||'').toLowerCase().includes(q)||p.team.toLowerCase().includes(q));
  ps.sort((a,b)=>{
    const av=sCol==='localOwnership'?a.fL:(a[sCol]??0);
    const bv=sCol==='localOwnership'?b.fL:(b[sCol]??0);
    return sDir*((typeof av==='string')?av.localeCompare(bv):bv-av);
  });
  const mgrList=D.managers.filter(m=>mgrOn.has(m.username));
  const el=document.getElementById('scoutList');
  if(!ps.length){el.innerHTML='<div class="spin-c" style="padding:30px">Niciun jucÄƒtor</div>';return;}
  el.innerHTML=ps.slice(0,150).map(p=>{
    const dots=mgrList.map(m=>{
      const o=(p.ownedBy||[]).includes(m.username);
      return`<span class="dot ${o?(m.guid===meGuid?'dot-me':'dot-ot'):'dot-em'}" title="${m.username}"></span>`;
    }).join('');
    const mdVal=p.curGDPts||0;
    return`<div class="sc-card${p.isMine?' mine':''}" onclick="showP(${p.id})">
      <div class="sc-left">
        <div class="sc-pts-big${p.isMine?' fire':''}">${p.totPts}</div>
        <div class="sc-pts-lbl">Total</div>
      </div>
      <div class="sc-mid">
        <div class="sc-name">${p.name}${p.isMine?' <span class="fire-tag">ðŸ”¥</span>':''}</div>
        <div class="sc-sub">
          <span class="pos-b pos-${p.posCode}">${p.posCode}</span>
          <span class="s-dot s${(p.status||'A').toLowerCase()}"></span>
          ${p.team}
        </div>
        <div class="sc-badges">
          <span class="pct-b ${pctCls(p.fP)}">${p.fP}%</span>
          <span style="font-size:10px;color:var(--muted)">ligÄƒ</span>
          <span class="pct-b plo">${p.selPer}%</span>
          <span style="font-size:10px;color:var(--muted)">global</span>
        </div>
        <div class="dots">${dots}</div>
      </div>
      <div class="sc-right">
        <div class="sc-md-pts">${mdVal}</div>
        <div class="sc-md-lbl">MD Pts</div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ TOTW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Dynamic formation picker:
// Rules: 1 GK, 3-5 DEF, 2-5 MID, 1-3 FWD, total=11
function pickBestXI(players){
  const bp={GK:[],DEF:[],MID:[],FWD:[]};
  players.forEach(p=>{if(bp[p.posCode])bp[p.posCode].push({...p});});
  Object.keys(bp).forEach(k=>bp[k].sort((a,b)=>b.mdPoints-a.mdPoints));

  // Try all valid formations and pick highest total
  let best=null, bestTotal=-1;
  // DEF 3-5, MID 2-5, FWD 1-3, sum outfield = 10
  for(let d=3;d<=5;d++){
    for(let m=2;m<=5;m++){
      const f=10-d-m;
      if(f<1||f>3)continue;
      if(bp.GK.length<1||bp.DEF.length<d||bp.MID.length<m||bp.FWD.length<f)continue;
      const squad=[bp.GK[0],...bp.DEF.slice(0,d),...bp.MID.slice(0,m),...bp.FWD.slice(0,f)];
      const total=squad.reduce((s,p)=>s+p.mdPoints,0);
      if(total>bestTotal){bestTotal=total;best={squad,d,m,f};}
    }
  }
  if(!best)return{squad:[],d:4,m:3,f:3};
  return best;
}

function renderTOTW(){
  if(!D)return;
  const ids=myIds();

  // Helper: get BASE points for a player (halve if captain, since UEFA API doubles captain mdPoints)
  function basePts(p){ return p.isCaptain ? Math.round((p.mdPoints||0)/2) : (p.mdPoints||0); }

  // 1) LIGA NOASTRÄ‚ â€” best starters, BASE points (no cap doubling)
  const pMap={};
  D.managers.forEach(m=>m.players.filter(p=>p.isStarter).forEach(p=>{
    const k=p.id;
    const bp=basePts(p);
    const existing=pMap[k];
    if(!existing||bp>existing.mdPoints||(bp===existing.mdPoints&&m.guid===meGuid))
      pMap[k]={...p,mdPoints:bp};  // store with base pts
  }));
  const localRes=pickBestXI(Object.values(pMap));

  // 2) GLOBAL TOTW â€” all public players, curGDPts = already base
  const globalRes=pickBestXI(D.allPlayers.map(p=>({...p,mdPoints:p.curGDPts||0,ownedBy:p.ownedBy||[]})));

  // 3) BEST IN LEAGUE this MD â€” manager with lowest gdRank = closest to global #1
  //    Note: actual global #1's team isn't available via public API, so we show
  //    the best manager from our league as comparison
  const bestMgr=[...D.managers].filter(m=>m.gdRank>0).sort((a,b)=>a.gdRank-b.gdRank)[0];
  const bestRes=bestMgr
    ? pickBestXI(bestMgr.players.filter(p=>p.isStarter).map(p=>({...p,mdPoints:basePts(p),ownedBy:p.ownedBy||[]})))
    : {squad:[],d:4,m:3,f:3};
  const bestLabel=bestMgr
    ? `${bestMgr.username} Â· <span style="font-size:9px;opacity:.7">#${(bestMgr.gdRank||0).toLocaleString()} global</span>`
    : 'â€”';

  document.getElementById('totwPair').innerHTML=`
    <div class="totw-half">
      <div class="totw-label local">Liga NoastrÄƒ <div class="totw-label-line"></div></div>
      ${buildPitch(localRes,ids)}
    </div>
    <div class="totw-half">
      <div class="totw-label global">Global TOTW <div class="totw-label-line"></div></div>
      ${buildPitch(globalRes,ids)}
    </div>
    <div class="totw-half">
      <div class="totw-label best">Cel mai aproape Â· ${bestLabel} <div class="totw-label-line"></div></div>
      ${buildPitch(bestRes,ids)}
    </div>`;
}

function buildPitch({squad,d,m,f},ids){
  if(!squad||!squad.length){
    return`<div class="pitch" style="height:480px"><div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,.4);font-size:13px">FÄƒrÄƒ date</div></div>`;
  }
  const byPos={GK:[],DEF:[],MID:[],FWD:[]};
  squad.forEach(p=>{if(byPos[p.posCode])byPos[p.posCode].push(p);});
  const form=`${d}-${m}-${f}`;
  const totalPts=squad.reduce((s,p)=>s+p.mdPoints,0);
  const mineCount=squad.filter(p=>ids.has(p.id)).length;
  const counterCls=mineCount>0?' has-mine':'';

  // Rows in pitch order: FWD top â†’ GK bottom
  const rows=[byPos.FWD,byPos.MID,byPos.DEF,byPos.GK].filter(r=>r.length>0);

  let h=`<div class="pitch">
    <div class="pitch-midcircle"></div>
    <div class="pitch-box-t"></div>
    <div class="pitch-box-b"></div>
    <div class="form-tag">${form}</div>
    <div class="pitch-counter${counterCls}">${mineCount}/11</div>`;

  rows.forEach((row,ri)=>{
    h+=`<div class="pitch-row">`;
    row.forEach(p=>{
      const mine=ids.has(p.id);
      const shortName=p.name.includes(' ')?p.name.split(' ').pop():p.name;
      h+=`<div class="pcard${mine?' mine':''}" onclick="showP(${p.id})">
        <div class="pcard-name">${shortName}</div>
        <div class="pcard-pts">${p.mdPoints}</div>
        <div class="pcard-team">${p.team||''}</div>
      </div>`;
    });
    h+=`</div>`;
  });

  // Total always at bottom inside pitch
  h+=`<div class="pitch-total">Total: <span>${totalPts} pts</span></div>`;
  h+=`</div>`;
  return h;
}

// â”€â”€ PLAYER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showP(id){
  const p=D.allPlayers.find(x=>x.id===id);if(!p)return;
  const mine=myIds().has(id);
  let mdPts=p.curGDPts||0;
  D.managers.forEach(m=>{const mp=m.players.find(x=>x.id===id);if(mp)mdPts=Math.max(mdPts,mp.mdPoints);});
  const sm={A:'Disponibil',I:'Accidentat',D:'Suspendat',PQ:'Incert'};
  const chips=(p.ownedBy||[]).length?(p.ownedBy||[]).map(n=>`<span class="owned-chip">${n}</span>`).join(''):`<span style="color:var(--muted);font-size:12px">Nimeni din ligÄƒ</span>`;
  document.getElementById('modal').innerHTML=`
    <div class="m-handle"></div>
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:4px">
      <span class="pos-b pos-${p.posCode}">${p.posCode}</span>
      ${mine?'<span class="fire-tag">ðŸ”¥ Echipa ta</span>':''}
    </div>
    <div class="m-name">${p.fullName||p.name}</div>
    <div class="m-sub">${p.team} Â· â‚¬${p.value}M Â· ${sm[p.status]||'Disponibil'}</div>
    <div class="stat-grid">
      <div class="stat-box"><div class="stat-v${mine?' fire':''}">${p.totPts}</div><div class="stat-l">Total Pts</div></div>
      <div class="stat-box"><div class="stat-v">${mdPts}</div><div class="stat-l">MD Pts</div></div>
      <div class="stat-box"><div class="stat-v">${p.rating||0}</div><div class="stat-l">Rating</div></div>
    </div>
    <div class="srow"><span>Goluri</span><b>${p.goals||0}</b></div>
    <div class="srow"><span>Assist-uri</span><b>${p.assists||0}</b></div>
    <div class="srow"><span>Clean sheets</span><b>${p.cleanSheets||0}</b></div>
    <div class="srow"><span>Man of the Match</span><b>${p.momCount||0}x</b></div>
    <div class="srow"><span>CÄƒrÈ›i galbene</span><b>${p.yellowCards||0}</b></div>
    <div class="srow"><span>SelecÈ›ie globalÄƒ</span><b>${p.selPer}%</b></div>
    <div class="sec-lbl">DeÈ›inut de</div>
    <div class="owned-wrap">${chips}</div>`;
  document.getElementById('overlay').classList.add('open');
}
function closeOv(e){
  if(!e||e.target===document.getElementById('overlay'))
    document.getElementById('overlay').classList.remove('open');
}

// â”€â”€ PIN â€” visual numpad, no plaintext code â”€â”€
function askRefresh(){
  pinBuffer=''; updatePinDots();
  document.getElementById('pinErr').textContent='';
  document.getElementById('pinOv').classList.add('open');
}
function closePin(){ document.getElementById('pinOv').classList.remove('open'); }
function pinKey(k){
  if(pinBuffer.length>=4)return;
  pinBuffer+=k; updatePinDots();
  if(pinBuffer.length===4) setTimeout(submitPin,120);
}
function pinDel(){ pinBuffer=pinBuffer.slice(0,-1); updatePinDots(); }
function updatePinDots(){
  for(let i=0;i<4;i++){
    document.getElementById('pd'+i).classList.toggle('filled',i<pinBuffer.length);
  }
}
async function submitPin(){
  if(!checkPin(pinBuffer)){
    document.getElementById('pinErr').textContent='âŒ Cod greÈ™it!';
    pinBuffer=''; updatePinDots(); return;
  }
  closePin();
  const b=document.getElementById('refBtn');
  b.classList.add('loading'); b.textContent='â†» ...';
  try{ await fetch(`/api/refresh?md=${MD}`,{method:'POST'}); await load(MD); }
  finally{ b.classList.remove('loading'); b.textContent='â†» Refresh'; }
}
</script>
</body>
</html>
